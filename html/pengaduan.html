<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pengaduan Masyarakat - Desa Banyusri</title>
  <link rel="stylesheet" href="../style/style-pengaduan.css" />
</head>
<body>
  <header>
    <h1>Form Pengaduan & Status</h1>
    <nav>
      <a href="dashboard.html">🏠 Beranda</a>
      <a href="profil.html">📋 Profil Desa</a>
      <a href="pengaduan.html">📝 Pengaduan</a>
      <a href="layanan.html">🛠️ Layanan Desa</a>
      <a href="pengumuman.html">📢 Pengumuman</a>
      <a href="register.html">👥 Daftar</a>
      <a href="#" id="logout-btn">🚪 Keluar</a>
    </nav>
  </header>

  <main>
    <div class="form-box">
      <h2>Kirim Pengaduan Baru</h2>
      <form id="form-pengaduan">
        <label for="nama">Nama Lengkap:</label>
        <input type="text" id="nama" placeholder="Masukkan nama lengkap Anda" required />

        <label for="isi">Isi Pengaduan:</label>
        <textarea id="isi" rows="6" placeholder="Jelaskan pengaduan Anda dengan detail..." required></textarea>

        <button type="submit">Kirim Pengaduan</button>
        <p id="status"></p>
      </form>
    </div>

    <div class="riwayat-box">
      <h2>Riwayat Pengaduan Anda</h2>
      <div id="riwayat-list">
        <div class="loading">Memuat riwayat pengaduan...</div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Desa Banyusri - KKN Kelompok 22 Periode 7</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/script.js"></script>

  <script>
  const db = firebase.firestore();
  let currentUser = null;

  // Check authentication
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      currentUser = user;
      console.log("User logged in:", user.email);
      // Auto-fill nama field if user has displayName
      if (user.displayName) {
        document.getElementById('nama').value = user.displayName;
      }
      loadRiwayatPengaduan();
    } else {
      console.log("No user logged in, redirecting...");
      window.location.href = 'login.html';
    }
  });

  // Fungsi untuk menampilkan riwayat pengaduan dari Firestore berdasarkan user login
  function loadRiwayatPengaduan() {
    const riwayatList = document.getElementById('riwayat-list');
    riwayatList.innerHTML = '<div class="loading">Memuat riwayat pengaduan...</div>';

    if (!currentUser) {
      riwayatList.innerHTML = '<div class="info">Silakan login terlebih dahulu.</div>';
      return;
    }

    // Query berdasarkan email user yang login
    db.collection("pengaduan")
      .where("email", "==", currentUser.email)
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          riwayatList.innerHTML = '<div class="info">Belum ada pengaduan.</div>';
          return;
        }
        let html = '<ul class="riwayat-ul">';
        snapshot.forEach(doc => {
          const data = doc.data();
          const tanggal = data.tanggal || (data.timestamp && data.timestamp.toDate().toLocaleDateString()) || '-';
          html += `<li>
            <strong>${tanggal}</strong><br>
            <span>${data.isi}</span><br>
            <em>Status: ${data.status || 'pending'}</em>
          </li>`;
        });
        html += '</ul>';
        riwayatList.innerHTML = html;
      })
      .catch(err => {
        console.error("Error loading riwayat:", err);
        riwayatList.innerHTML = '<div class="status-error">Gagal memuat riwayat: ' + err.message + '</div>';
      });
  }

  // Fungsi untuk menangani submit form
  document.getElementById('form-pengaduan').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!currentUser) {
      alert('Silakan login terlebih dahulu!');
      return;
    }

    const nama = document.getElementById('nama').value;
    const isi = document.getElementById('isi').value;
    const statusElement = document.getElementById('status');

    if (nama && isi) {
      // Simpan dengan email user yang login
      db.collection("pengaduan").add({
        nama: nama,
        email: currentUser.email,
        isi: isi,
        status: "pending",
        timestamp: new Date(),
        tanggal: new Date().toISOString().split('T')[0]
      })
      .then(() => {
        statusElement.textContent = 'Pengaduan berhasil dikirim!';
        statusElement.className = 'status-success';
        document.getElementById('isi').value = '';
        loadRiwayatPengaduan();
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = '';
        }, 3000);
      })
      .catch(err => {
        console.error("Error submitting pengaduan:", err);
        statusElement.textContent = 'Gagal mengirim pengaduan: ' + err.message;
        statusElement.className = 'status-error';
      });
    } else {
      statusElement.textContent = 'Mohon lengkapi semua field!';
      statusElement.className = 'status-error';
    }
  });

  // Load riwayat saat halaman dimuat
  document.addEventListener('DOMContentLoaded', function() {
    // Remove the input event listener for nama field since we're now using email-based queries
    // loadRiwayatPengaduan(); // This will be called by onAuthStateChanged
  });

  // Logout functionality
  document.getElementById('logout-btn').addEventListener('click', function(e) {
    e.preventDefault();
    if (confirm('Apakah Anda yakin ingin keluar?')) {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error('Error signing out:', error);
      });
    }
  });
  </script>
</body>
</html>